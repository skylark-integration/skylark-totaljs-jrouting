{"version":3,"sources":["jR.js"],"names":["define","skylark","JRFU","jR","LIMIT_HISTORY","LIMIT_HISTORY_ERROR","version","cache","routes","history","errors","events","eventsOnce","global","query","params","middlewares","repository","url","model","isFirst","isReady","isRefresh","isModernBrowser","pushState","hashtags","count","window","jRouting","remove","i","length","this","id","push","on","name","fn","e","once","emit","lengthOnce","tmp","arguments","apply","route","middleware","init","Array","priority","indexOf","_route","trim","split","mid","roles","options","forEach","item","substring","pending","sort","a","b","refresh","location","reload","async","jRoute","shift","is404","charCodeAt","arr","_route_param","routeUrl","value","_route_compare","skip","index","prepareUrl","path","self","notfound","raw","toLowerCase","_params","l","j","next","call","err","status","Error","prev","back","pop","redirect","code","message","hash","href","data","slice","param","decodeURIComponent","isArray","d","prototype","callback","undefined","setTimeout","String","text","error","date","Date","clientside","selector","$","document","preventDefault","el","attr","g","jquery","replace","handler","filter","bind","ready","pathname","attach"],"mappings":"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","file":"../jR.js","sourcesContent":["define([\n\t\"skylark-langx/skylark\"\n],function(skylark){\n\tvar JRFU = {};\n\tvar jR = {\n\t\tLIMIT_HISTORY: 100,\n\t\tLIMIT_HISTORY_ERROR: 100,\n\t\tversion: 'v3.0.0',\n\t\tcache: {},\n\t\troutes: [],\n\t\thistory: [],\n\t\terrors: [],\n\t\tevents: {},\n\t\teventsOnce: {},\n\t\tglobal: {},\n\t\tquery: {},\n\t\tparams: [],\n\t\tmiddlewares: {},\n\t\trepository: {},\n\t\turl: '',\n\t\tmodel: null,\n\t\tisFirst: true,\n\t\tisReady: false,\n\t\tisRefresh: false,\n\t\tisModernBrowser: history.pushState ? true : false,\n\t\thashtags: false,\n\t\tcount: 0\n\t};\n\n\tif (!window.jR)\n\t\twindow.jR = jR;\n\n\tif (!window.jRouting)\n\t\twindow.jRouting = jR;\n\n\tif (!window.JRFU)\n\t\twindow.JRFU = JRFU;\n\n\tjR.remove = function(url) {\n\t\tvar self = this;\n\t\tvar routes = [];\n\t\tfor (var i = 0, length = self.routes.length; i < length; i++)\n\t\t\tself.routes[i].id !== url && routes.push(self.routes[i]);\n\t\tself.routes = routes;\n\t\treturn self;\n\t};\n\n\tjR.on = function(name, fn) {\n\t\tvar self = this;\n\t\tvar e = self.events[name];\n\t\tif (e)\n\t\t\te.push(fn);\n\t\telse\n\t\t\tself.events[name] = [fn];\n\t\treturn self;\n\t};\n\n\tjR.once = function(name, fn) {\n\t\tvar self = this;\n\t\tvar e = self.eventsOnce[name];\n\t\tif (e)\n\t\t\te.push(fn);\n\t\telse\n\t\t\tself.eventsOnce[name] = [fn];\n\t\treturn self;\n\t};\n\n\tjR.emit = function(name) {\n\n\t\tvar self = this;\n\t\tvar events = self.events[name] || [];\n\t\tvar eventsOnce = self.eventsOnce[name] || [];\n\t\tvar length = events.length;\n\t\tvar lengthOnce = eventsOnce.length;\n\n\t\tif (!length && !lengthOnce)\n\t\t\treturn self;\n\n\t\tvar params = [];\n\t\tvar tmp = arguments.length;\n\n\t\tfor (var i = 1; i < tmp; i++)\n\t\t\tparams.push(arguments[i]);\n\n\t\tif (length > 0) {\n\t\t\tfor (var i = 0; i < length; i++)\n\t\t\t\tevents[i].apply(self, params);\n\t\t}\n\n\t\tif (lengthOnce) {\n\t\t\tfor (var i = 0; i < length; i++)\n\t\t\t\teventsOnce[i].apply(self, params);\n\t\t\tdelete self.eventsOnce[name];\n\t\t}\n\n\t};\n\n\tjR.route = function(url, fn, middleware, init) {\n\n\t\tvar tmp;\n\n\t\tif (fn instanceof Array) {\n\t\t\tvar tmp = middleware;\n\t\t\tmiddleware = fn;\n\t\t\tfn = tmp;\n\t\t}\n\n\t\tif (typeof(middleware) === 'function') {\n\t\t\ttmp = init;\n\t\t\tinit = middleware;\n\t\t\tmiddleware = tmp;\n\t\t}\n\n\t\tvar priority = url.count('/') + (url.indexOf('*') === -1 ? 0 : 10);\n\t\tvar route = jR._route(url.trim());\n\t\tvar params = [];\n\n\t\tif (typeof(middleware) === 'string')\n\t\t\tmiddleware = middleware.split(',');\n\n\t\tvar mid = [];\n\t\tvar roles = [];\n\t\tvar options = {};\n\n\t\t(middleware instanceof Array) && middleware.forEach(function(item) {\n\t\t\tif (typeof(item) === 'object')\n\t\t\t\toptions = item;\n\t\t\telse if (item.substring(0, 1) === '@')\n\t\t\t\troles.push(item.substring(1));\n\t\t\telse\n\t\t\t\tmid.push(item);\n\t\t});\n\n\t\tif (url.indexOf('{') !== -1) {\n\t\t\tpriority -= 100;\n\t\t\tfor (var i = 0; i < route.length; i++)\n\t\t\t\troute[i].substring(0, 1) === '{' && params.push(i);\n\t\t\tpriority -= params.length;\n\t\t}\n\n\t\tjR.remove(url);\n\t\tjR.routes.push({ id: url, url: route, fn: fn, priority: priority, params: params, middleware: mid.length ? mid : null, init: init, count: 0, pending: false, options: options, roles: roles });\n\t\tjR.routes.sort(function(a, b) {\n\t\t\treturn a.priority > b.priority ? -1 : a.priority < b.priority ? 1 :0;\n\t\t});\n\n\t\treturn jR;\n\t};\n\n\tjR.middleware = function(name, fn) {\n\t\tvar self = this;\n\t\tself.middlewares[name] = fn;\n\t\treturn self;\n\t};\n\n\tjR.refresh = function() {\n\t\tvar self = this;\n\t\treturn self.location(self.url, true);\n\t};\n\n\tjR.reload = function() {\n\t\treturn jR.refresh();\n\t};\n\n\tjR.async = function() {\n\t\tif (!window.jRoute || !window.jRoute.length)\n\t\t\treturn;\n\t\twhile (true) {\n\t\t\tvar fn = window.jRoute.shift();\n\t\t\tif (!fn)\n\t\t\t\tbreak;\n\t\t\tfn();\n\t\t}\n\t\tjR.is404 && jR.location(jR.url);\n\t};\n\n\tjR._route = function(url) {\n\n\t\tif (url.charCodeAt(0) === 47)\n\t\t\turl = url.substring(1);\n\n\t\tif (url.charCodeAt(url.length - 1) === 47)\n\t\t\turl = url.substring(0, url.length - 1);\n\n\t\tvar arr = url.split('/');\n\t\tif (arr.length === 1 && !arr[0])\n\t\t\tarr[0] = '/';\n\n\t\treturn arr;\n\t};\n\n\tjR._route_param = function(routeUrl, route) {\n\t\tvar arr = [];\n\n\t\tif (!route || !routeUrl)\n\t\t\treturn arr;\n\n\t\tvar length = route.params.length;\n\t\tif (length) {\n\t\t\tfor (var i = 0; i < length; i++) {\n\t\t\t\tvar value = routeUrl[route.params[i]];\n\t\t\t\tarr.push(value === '/' ? '' : value);\n\t\t\t}\n\t\t}\n\n\t\treturn arr;\n\t};\n\n\tjR._route_compare = function(url, route) {\n\n\t\tvar length = url.length;\n\t\tvar skip = length === 1 && url[0] === '/';\n\n\t\tif (route.length !== length)\n\t\t\treturn false;\n\n\t\tfor (var i = 0; i < length; i++) {\n\n\t\t\tvar value = route[i];\n\t\t\tif (!value)\n\t\t\t\treturn false;\n\n\t\t\tif (!skip && value.charCodeAt(0) === 123)\n\t\t\t\tcontinue;\n\n\t\t\tif (value === '*')\n\t\t\t\treturn true;\n\n\t\t\tif (url[i] !== value)\n\t\t\t\treturn false;\n\t\t}\n\n\t\treturn true;\n\t};\n\n\tjR.location = function(url, isRefresh) {\n\n\t\tif (!jR.isReady)\n\t\t\treturn;\n\n\t\tvar index = url.indexOf('?');\n\t\tif (index !== -1)\n\t\t\turl = url.substring(0, index);\n\n\t\turl = JRFU.prepareUrl(url);\n\t\turl = JRFU.path(url);\n\n\t\tvar self = this;\n\t\tvar path = self._route(url);\n\t\tvar routes = [];\n\t\tvar notfound = true;\n\t\tvar raw = [];\n\n\t\traw.push.apply(raw, path);\n\n\t\tfor (var i = 0, length = path.length; i < length; i++)\n\t\t\tpath[i] = path[i].toLowerCase();\n\n\t\tself.isRefresh = isRefresh || false;\n\t\tself.count++;\n\n\t\tif (!isRefresh && self.url.length && self.history[self.history.length - 1] !== self.url) {\n\t\t\tself.history.push(self.url);\n\t\t\tself.history.length > self.LIMIT_HISTORY && self.history.shift();\n\t\t}\n\n\t\tvar length = self.routes.length;\n\t\tfor (var i = 0; i < length; i++) {\n\n\t\t\tvar route = self.routes[i];\n\t\t\tif (!self._route_compare(path, route.url))\n\t\t\t\tcontinue;\n\n\t\t\tif (route.url.indexOf('*') === -1)\n\t\t\t\tnotfound = false;\n\n\t\t\tif (route.once && route.count > 0)\n\t\t\t\tcontinue;\n\n\t\t\troute.count++;\n\t\t\troutes.push(route);\n\t\t\tbreak;\n\t\t}\n\n\t\tvar isError = false;\n\t\tvar error = [];\n\n\t\t// cache old repository\n\n\t\tif (self.url.length)\n\t\t\tself.cache[self.url] = self.repository;\n\n\t\tself.url = url;\n\t\tself.repository = self.cache[url];\n\n\t\tif (!self.repository)\n\t\t\tself.repository = {};\n\n\t\tself._params();\n\t\tself.params = self._route_param(raw, route);\n\t\tself.is404 = false;\n\t\tself.emit('location', url);\n\t\tlength = routes.length;\n\n\t\tfor (var i = 0; i < length; i++) {\n\t\t\tvar route = routes[i];\n\n\t\t\tif (route.pending)\n\t\t\t\tcontinue;\n\n\t\t\tif (!route.middleware || !route.middleware.length) {\n\t\t\t\tif (!route.init) {\n\t\t\t\t\troute.fn.apply(self, self.params);\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\troute.pending = true;\n\n\t\t\t\t(function(route) {\n\t\t\t\t\troute.init(function() {\n\t\t\t\t\t\troute.fn.apply(self, self.params);\n\t\t\t\t\t\troute.pending = false;\n\t\t\t\t\t});\n\t\t\t\t})(route);\n\n\t\t\t\troute.init = null;\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\t(function(route) {\n\n\t\t\t\tvar l = route.middleware.length;\n\t\t\t\tvar middleware = [];\n\n\t\t\t\tfor (var j = 0; j < l; j++) {\n\t\t\t\t\tvar fn = jR.middlewares[route.middleware[j]];\n\t\t\t\t\tfn && (function(route, fn) {\n\t\t\t\t\t\tmiddleware.push(function(next) {\n\t\t\t\t\t\t\tfn.call(jR, next, route.options, route.roles, route);\n\t\t\t\t\t\t});\n\t\t\t\t\t})(route, fn);\n\t\t\t\t}\n\n\t\t\t\tif (!route.init) {\n\t\t\t\t\troute.pending = true;\n\t\t\t\t\tmiddleware.middleware(function(err) {\n\t\t\t\t\t\t!err && route.fn.apply(jR, jR.params);\n\t\t\t\t\t\troute.pending = false;\n\t\t\t\t\t}, route);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\troute.pending = true;\n\t\t\t\troute.init(function() {\n\t\t\t\t\tmiddleware.middleware(function(err) {\n\t\t\t\t\t\t!err && route.fn.apply(jR, jR.params);\n\t\t\t\t\t\troute.pending = false;\n\t\t\t\t\t}, route);\n\t\t\t\t});\n\n\t\t\t\troute.init = null;\n\t\t\t})(route);\n\t\t}\n\n\t\tisError && self.status(500, error);\n\t\tself.is404 = true;\n\t\tnotfound && self.status(404, new Error('Route not found.'));\n\t};\n\n\tjR.prev = function() {\n\t\treturn this.history[this.history.length - 1];\n\t};\n\n\tjR.back = function() {\n\t\tvar self = this;\n\t\tvar url = self.history.pop() || '/';\n\t\tself.url = '';\n\t\tself.redirect(url, true);\n\t\treturn self;\n\t};\n\n\tjR.status = function(code, message) {\n\t\tvar self = this;\n\t\tself.emit('status', code || 404, message);\n\t\treturn self;\n\t};\n\n\tjR.redirect = function(url, model) {\n\t\tvar self = this;\n\n\t\tif (url.charCodeAt(0) === 35) {\n\t\t\tlocation.hash = url;\n\t\t\tself.model = model || null;\n\t\t\tself.location(url, false);\n\t\t\treturn self;\n\t\t}\n\n\t\tif (!self.isModernBrowser) {\n\t\t\tlocation.href = url;\n\t\t\treturn false;\n\t\t}\n\n\t\thistory.pushState(null, null, url);\n\t\tself.model = model || null;\n\t\tself.location(url, false);\n\t\treturn self;\n\t};\n\n\tjR._params = function() {\n\n\t\tvar self = this;\n\t\tvar data = {};\n\n\t\tvar params = location.href.slice(location.href.indexOf('?') + 1).split('&');\n\n\t\tfor (var i = 0; i < params.length; i++) {\n\n\t\t\tvar param = params[i].split('=');\n\t\t\tif (param.length !== 2)\n\t\t\t\tcontinue;\n\n\t\t\tvar name = decodeURIComponent(param[0]);\n\t\t\tvar value = decodeURIComponent(param[1]);\n\t\t\tvar isArray = data[name] instanceof Array;\n\n\t\t\tif (data[name] && !isArray)\n\t\t\t\tdata[name] = [data[name]];\n\n\t\t\tif (isArray)\n\t\t\t\tdata[name].push(value);\n\t\t\telse\n\t\t\t\tdata[name] = value;\n\t\t}\n\n\t\tself.query = data;\n\t\treturn self;\n\t};\n\n\tjR.path = JRFU.path = function (url, d) {\n\n\t\tif (url.substring(0, 1) === '#')\n\t\t\treturn url;\n\n\t\tif (!d)\n\t\t\td = '/';\n\n\t\tvar index = url.indexOf('?');\n\t\tvar params = '';\n\n\t\tif (index !== -1) {\n\t\t\tparams = url.substring(index);\n\t\t\turl = url.substring(0, index);\n\t\t}\n\n\t\tvar l = url.length;\n\t\tvar c = url.substring(l - 1, l);\n\t\tif (c !== d)\n\t\t\turl += d;\n\n\t\treturn url + params;\n\t};\n\n\tJRFU.prepareUrl = function(url) {\n\t\tif (url.substring(0, 1) === '#')\n\t\t\treturn url;\n\t\tvar index = url.indexOf('#');\n\t\treturn index !== -1 ? url.substring(0, index) : url;\n\t};\n\n\tif (!Array.prototype.middleware) {\n\t\tArray.prototype.middleware = function(callback, route) {\n\n\t\t\tvar self = this;\n\t\t\tvar item = self.shift();\n\n\t\t\tif (item === undefined) {\n\t\t\t\tcallback && callback();\n\t\t\t\treturn self;\n\t\t\t}\n\n\t\t\titem(function(err) {\n\t\t\t\tif (err instanceof Error || err === false)\n\t\t\t\t\tcallback && callback(err === false ? true : err);\n\t\t\t\telse setTimeout(function() {\n\t\t\t\t\tself.middleware(callback, route);\n\t\t\t\t}, 1);\n\t\t\t}, route.options, route.roles);\n\n\t\t\treturn self;\n\t\t};\n\t}\n\n\tif (!String.prototype.count) {\n\t\tString.prototype.count = function(text) {\n\t\t\tvar index = 0;\n\t\t\tvar count = 0;\n\t\t\tdo {\n\t\t\t\tindex = this.indexOf(text, index + text.length);\n\t\t\t\tif (index > 0)\n\t\t\t\t\tcount++;\n\t\t\t} while (index > 0);\n\t\t\treturn count;\n\t\t};\n\t}\n\n\tjR.on('error', function (err, url, name) {\n\t\tvar self = this;\n\t\tself.errors.push({ error: err, url: url, name: name, date: new Date() });\n\t\tself.errors.length > self.LIMIT_HISTORY_ERROR && self.errors.shift();\n\t});\n\n\tjR.clientside = function(selector) {\n\t\t$(document).on('click', selector, function(e) {\n\t\t\te.preventDefault();\n\t\t\tvar el = $(this);\n\t\t\tjR.redirect(el.attr('href') || el.attr('data-jrouting') || el.attr('data-jr'));\n\t\t});\n\t\treturn jR;\n\t};\n\n\tfunction jRinit() {\n\t\tjR.async();\n\t\t$.fn.jRouting = function(g) {\n\n\t\t\tif (jR.hashtags || !jR.isModernBrowser)\n\t\t\t\treturn this;\n\n\t\t\tvar version = +$.fn.jquery.replace(/\\./g, '');\n\t\t\tif (version >= 300 && g === true)\n\t\t\t\tthrow Error('$(selector).jRouting() doesn\\'t work in jQuery +3. Instead of this use jR.clientside(selector).');\n\n\t\t\tvar handler = function(e) {\n\t\t\t\te.preventDefault();\n\t\t\t\tjR.redirect($(this).attr('href'));\n\t\t\t};\n\n\t\t\tif (g)\n\t\t\t\t$(document).on('click', this.selector, handler);\n\t\t\telse\n\t\t\t\tthis.filter('a').bind('click', handler);\n\n\t\t\treturn this;\n\t\t};\n\n\t\t$(document).ready(function() {\n\n\t\t\tjR.async();\n\n\t\t\tif (jR.hashtags)\n\t\t\t\tjR.url = location.hash || JRFU.path(JRFU.prepareUrl(location.pathname));\n\t\t\telse\n\t\t\t\tjR.url = JRFU.path(JRFU.prepareUrl(location.pathname));\n\n\t\t\tif (jR.events.ready) {\n\t\t\t\tjR.emit('ready', jR.url);\n\t\t\t\tjR.emit('load', jR.url);\n\t\t\t} else {\n\t\t\t\tsetTimeout(function() {\n\t\t\t\t\tjR.isReady = true;\n\t\t\t\t\tjR.location(jR.url);\n\t\t\t\t\tjR.emit('ready', jR.url);\n\t\t\t\t\tjR.emit('load', jR.url);\n\t\t\t\t}, 5);\n\t\t\t}\n\n\t\t\t$(window).on('hashchange', function() {\n\t\t\t\tif (!jR.isReady || !jR.hashtags)\n\t\t\t\t\treturn;\n\t\t\t\tjR.location(JRFU.path(location.hash));\n\t\t\t});\n\n\t\t\t$(window).on('popstate', function() {\n\t\t\t\tif (!jR.isReady || jR.hashtags)\n\t\t\t\t\treturn;\n\t\t\t\tvar url = JRFU.path(location.pathname);\n\t\t\t\tjR.url !== url && jR.location(url);\n\t\t\t});\n\t\t});\n\t}\n\n\tjRinit();\n\n\treturn skylark.attach(\"intg.totaljs.jR\",jR);\n\n});\n\n\n\n"]}